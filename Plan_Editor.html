<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>卓碼資訊 MES BOX 年度業務銷售計劃 (OGSM) v6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f4f7f9;
        }
        .nav-link {
            transition: color 0.3s, border-bottom-color 0.3s;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active, .nav-link:hover {
            color: #1d4ed8;
            border-bottom-color: #1d4ed8;
        }
        .content-section {
            scroll-margin-top: 80px;
        }
        .ogsm-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
            border: 1px solid #e5e7eb;
        }
        .quarter-tab.active {
            background-color: #1d4ed8;
            color: white;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            max-width: 300px;
            margin: auto;
        }
        .dashboard-chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }
        .gemini-modal { display: none; }
        .gemini-modal.show { display: flex; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- 全局編輯模式樣式 --- */
        .editable {
            transition: box-shadow 0.2s, background-color 0.2s;
        }
        body.edit-mode-active .editable {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
            background-color: #eff6ff;
            border-radius: 0.25rem;
        }
        body.edit-mode-active .add-action-btn,
        body.edit-mode-active .remove-action-btn {
            display: inline-flex;
        }
        .add-action-btn, .remove-action-btn {
            display: none;
        }

        /* --- 試算表樣式 --- */
        .spreadsheet-table th, .spreadsheet-table td {
            padding: 0.5rem;
            text-align: right;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        .spreadsheet-table th { background-color: #f9fafb; font-weight: 600; }
        .spreadsheet-table .metric-header { text-align: left; font-weight: 600; }
        .spreadsheet-table .quarter-total, .spreadsheet-table .annual-total { background-color: #f3f4f6; font-weight: 700; }
        
        /* --- AI Modal Content Styling --- */
        #gemini-modal-content h1, #gemini-modal-content h2, #gemini-modal-content h3 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        #gemini-modal-content h1 { font-size: 1.5em; }
        #gemini-modal-content h2 { font-size: 1.25em; }
        #gemini-modal-content h3 { font-size: 1.1em; }
        #gemini-modal-content ul, #gemini-modal-content ol { margin-left: 1.5rem; margin-bottom: 1em; }
        #gemini-modal-content ul { list-style-type: disc; }
        #gemini-modal-content ol { list-style-type: decimal; }
        #gemini-modal-content p { margin-bottom: 0.75em; line-height: 1.6; }
        #gemini-modal-content strong { font-weight: bold; }
        #gemini-modal-content code { background-color: #e5e7eb; padding: 0.1rem 0.3rem; border-radius: 0.25rem; font-family: monospace; }
    </style>
</head>
<body class="text-gray-900">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-2 md:gap-4">
                    <h1 id="main-title" class="text-xl md:text-2xl font-black p-1 rounded editable" contenteditable="false" data-key-path="textData.mainTitle"></h1>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <nav class="hidden md:flex items-center space-x-4 lg:space-x-6 text-sm lg:text-base">
                        <a href="#objective" class="nav-link font-semibold">目標 (O)</a>
                        <a href="#goals" class="nav-link font-semibold">指標 (G)</a>
                        <a href="#strategies" class="nav-link font-semibold">策略 (S)</a>
                        <a href="#analysis" class="nav-link font-semibold">數據分析</a>
                        <a href="#measures" class="nav-link font-semibold">執行方案 (M)</a>
                    </nav>
                    <button id="save-as-version-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors whitespace-nowrap">另存新版</button>
                    <button id="global-edit-toggle" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors whitespace-nowrap">編輯模式</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-12">
        <!-- Objective -->
        <section id="objective" class="content-section text-center mb-16">
            <div class="ogsm-card p-8">
                <h2 class="text-sm font-bold uppercase text-blue-600 tracking-widest mb-4">OBJECTIVE (終極目標)</h2>
                <p id="objective-text" class="text-2xl md:text-3xl font-bold max-w-4xl mx-auto p-2 rounded editable" contenteditable="false" data-key-path="textData.objective"></p>
            </div>
        </section>

        <!-- Goals -->
        <section id="goals" class="content-section mb-16">
            <div class="text-center mb-4">
                 <h2 id="goals-title" class="text-3xl font-bold p-1 rounded editable" contenteditable="false" data-key-path="textData.goalsTitle"></h2>
                <p id="goals-subtitle" class="text-gray-600 mt-2 p-1 rounded editable" contenteditable="false" data-key-path="textData.goalsSubtitle"></p>
            </div>
            <div class="ogsm-card p-6 mb-10">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="text-center"><p class="text-gray-500">年度總業績</p><p class="text-4xl font-extrabold text-green-600 my-2">NT$ <span id="total-revenue"></span></p></div>
                    <div class="text-center"><p class="text-gray-500">年度總銷售套數</p><p class="text-4xl font-extrabold text-blue-600 my-2"><span id="total-units"></span> 套</p></div>
                    <div class="text-center"><p class="text-gray-500">年度有效商機</p><p class="text-4xl font-extrabold text-yellow-600 my-2"><span id="total-opportunities"></span> 件</p></div>
                    <div class="text-center"><p class="text-gray-500">年度潛在客戶</p><p class="text-4xl font-extrabold text-purple-600 my-2"><span id="total-leads"></span> 筆</p></div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="ogsm-card p-6"><h3 class="font-bold text-lg text-center mb-4">業績目標構成</h3><div class="chart-container"><canvas id="revenueChart"></canvas></div></div>
                <div class="ogsm-card p-6"><h3 class="font-bold text-lg text-center mb-4">銷售套數目標構成</h3><div class="chart-container"><canvas id="unitsChart"></canvas></div></div>
            </div>
        </section>

        <!-- Strategies -->
        <section id="strategies" class="content-section mb-16">
            <div class="text-center mb-10">
                <h2 id="strategies-title" class="text-3xl font-bold p-1 rounded editable" contenteditable="false" data-key-path="textData.strategiesTitle"></h2>
                <p id="strategies-subtitle" class="text-gray-600 mt-2 p-1 rounded editable" contenteditable="false" data-key-path="textData.strategiesSubtitle"></p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="ogsm-card p-6"><h3 class="font-bold text-xl mb-2 p-1 rounded editable" contenteditable="false" data-key-path="textData.s1Title"></h3><p class="text-gray-600 p-1 rounded editable" contenteditable="false" data-key-path="textData.s1Desc"></p></div>
                <div class="ogsm-card p-6"><h3 class="font-bold text-xl mb-2 p-1 rounded editable" contenteditable="false" data-key-path="textData.s2Title"></h3><p class="text-gray-600 p-1 rounded editable" contenteditable="false" data-key-path="textData.s2Desc"></p></div>
                <div class="ogsm-card p-6"><h3 class="font-bold text-xl mb-2 p-1 rounded editable" contenteditable="false" data-key-path="textData.s3Title"></h3><p class="text-gray-600 p-1 rounded editable" contenteditable="false" data-key-path="textData.s3Desc"></p></div>
                <div class="ogsm-card p-6"><h3 class="font-bold text-xl mb-2 p-1 rounded editable" contenteditable="false" data-key-path="textData.s4Title"></h3><p class="text-gray-600 p-1 rounded editable" contenteditable="false" data-key-path="textData.s4Desc"></p></div>
            </div>
            <div class="ogsm-card p-6 mt-8 bg-blue-50 border-blue-200">
                <h3 class="font-bold text-xl mb-2 text-blue-800 p-1 rounded editable" contenteditable="false" data-key-path="textData.coreStrategyTitle"></h3>
                <p class="text-blue-700 p-1 rounded editable" contenteditable="false" data-key-path="textData.coreStrategyDesc"></p>
            </div>
        </section>

        <!-- Data Analysis -->
        <section id="analysis" class="content-section mb-16">
            <div class="text-center mb-10"><h2 class="text-3xl font-bold">目標數據分析</h2><p class="text-gray-600 mt-2">將年度總目標分解至團隊成員，並以視覺化圖表追蹤績效</p></div>
            <div class="ogsm-card p-6 md:p-8 space-y-12">
                <div>
                    <h3 class="font-bold text-xl mb-4">目標規劃試算表</h3>
                    <div class="overflow-x-auto"><table id="goal-spreadsheet" class="w-full text-sm spreadsheet-table"></table></div>
                </div>
                <div>
                    <div class="flex flex-wrap items-center justify-between mb-6">
                        <h3 class="font-bold text-xl mb-4 sm:mb-0">團隊績效儀表板</h3>
                        <button id="ai-analyst-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2">✨ 生成AI洞察</button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="lg:col-span-2 ogsm-card p-4"><h4 class="font-semibold text-center mb-2">團隊季度業績與套數目標</h4><div class="dashboard-chart-container"><canvas id="quarterlyPerformanceChart"></canvas></div></div>
                        <div class="lg:col-span-2 ogsm-card p-4"><h4 class="font-semibold text-center mb-2">團隊月度業績與套數目標趨勢</h4><div class="dashboard-chart-container"><canvas id="monthlyPerformanceChart"></canvas></div></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Measures -->
        <section id="measures" class="content-section mb-16">
            <div class="text-center mb-10"><h2 class="text-3xl font-bold">執行方案 (Measures)</h2><p class="text-gray-600 mt-2">將年度計畫拆解為季度與月份，確保策略的有效執行與即時調整</p></div>
            <div class="ogsm-card p-6 md:p-8">
                <div id="quarter-tabs-container" class="flex flex-wrap justify-center border-b border-gray-200 mb-6">
                    <button data-quarter="q1" class="quarter-tab text-lg font-semibold py-3 px-4 md:px-6 -mb-px border-b-2 border-transparent">第一季度 (Q1)</button>
                    <button data-quarter="q2" class="quarter-tab text-lg font-semibold py-3 px-4 md:px-6 -mb-px border-b-2 border-transparent">第二季度 (Q2)</button>
                    <button data-quarter="q3" class="quarter-tab text-lg font-semibold py-3 px-4 md:px-6 -mb-px border-b-2 border-transparent">第三季度 (Q3)</button>
                    <button data-quarter="q4" class="quarter-tab text-lg font-semibold py-3 px-4 md:px-6 -mb-px border-b-2 border-transparent">第四季度 (Q4)</button>
                </div>
                <div id="measures-content"></div>
            </div>
        </section>
    </main>

    <footer class="text-center py-8 mt-12 text-gray-500"><p>卓碼資訊股份有限公司 | 2025年度業務銷售計劃</p></footer>

    <!-- Gemini API Modal -->
    <div id="gemini-modal" class="gemini-modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b"><h3 id="gemini-modal-title" class="text-xl font-bold">AI 助理</h3><button id="gemini-modal-close" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div>
            <div id="gemini-modal-content" class="p-6 overflow-y-auto prose"></div>
            <div id="gemini-modal-loader" class="p-6 text-center hidden"><div class="spinner mx-auto"></div><p class="mt-4 text-gray-600">AI 生成中，請稍候...</p></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- DATA STORE (SINGLE SOURCE OF TRUTH) ---
        // These objects hold the entire state of the application.
        let dataStore = {
            textData: {
                mainTitle: "MES BOX 2025 業務銷售計劃 v6",
                objective: "成為台灣中小製造業在智慧轉型市場中，首選的MES解決方案領導品牌，並以「MES BOX」作為實現工廠數位化、透明化的最佳入門產品。",
                goalsTitle: "具體目標 (Goals)",
                goalsSubtitle: "以3人業務團隊，達成以下年度量化目標",
                strategiesTitle: "策略 (Strategies)",
                strategiesSubtitle: "為達成目標，我們將推行四大核心策略",
                s1Title: "S1: 產品組合與價值定位", s1Desc: "針對不同規模與需求的客戶，精準推廣對應的方案組合，最大化市場覆蓋率與營收。",
                s2Title: "S2: 市場深耕與通路拓展", s2Desc: "鎖定高潛力產業進行深度開發，並啟動白牌授權(OEM)計畫，拓展多元銷售通路。",
                s3Title: "S3: 顧問式銷售與內容行銷", s3Desc: "運用白皮書與產業分析內容，將業務團隊定位為「智慧製造顧問」，透過教育市場來創造需求。",
                s4Title: "S4: 團隊賦能與績效管理", s4Desc: "建立清晰的執行方案與檢核指標，賦能團隊達成目標並持續優化。",
                coreStrategyTitle: "🚀 核心賦能策略: IIoT/SCADA 整合方案", coreStrategyDesc: "與 **風巽達科技** 合作，共同開發 IIoT/SCADA 與雲端 MES 的整合解決方案。此合作將大幅強化 **Enterprise 企業版** 的產品競爭力，為下半年的高價值市場客戶提供從數據採集到製造執行的完整方案，是達成年度目標的關鍵引擎。"
            },
            appData: {
                goals: {
                    revenue: [1000000, 1500000, 2000000, 2200000, 2500000, 2800000, 2600000, 2600000, 2800000, 3300000, 3300000, 3400000],
                    units: [7, 7, 6, 9, 9, 9, 8, 8, 9, 10, 9, 10],
                    opportunities: [20, 20, 25, 25, 25, 25, 25, 25, 25, 30, 25, 25],
                    leads: [100, 120, 130, 120, 130, 120, 130, 120, 130, 150, 120, 130]
                },
                revenueDistribution: { essential: 0.33, standard: 0.298, enterprise: 0.3253, valueAdd: 0.0467 },
                unitsDistribution: { essential: 0.5, standard: 0.3, enterprise: 0.2 },
            },
            measuresData: {
                q1: { focus: '基礎建設、市場預熱 暨 整合方案啟動', months: [ { name: 'M1', strategy: '內部賦能與整合方案啟動', actions: ['業務團隊內部賦能，完成產品測驗。', '與風巽達合作，啟動整合方案需求分析與API設計。'], kpi: '產出需求規格書與SCADA→MES介面設計文件。' }, { name: 'M2', strategy: '內容行銷與原型開發', actions: ['推廣Essential方案與政府補助案。', '合作進行IIoT+MES原型開發與環境建置。'], kpi: '成功媒合5個補助案。完成SCADA原型與MES API文檔。' }, { name: 'M3', strategy: '線上預熱與整合測試', actions: ['舉辦「解鎖工廠數據力」線上研討會。', '完成資料串接與雙向測試，並發送軟啟動邀請函。'], kpi: '研討會報名80人。產出串接測試報告。' } ] },
                q2: { focus: '主力方案銷售 暨 整合方案展示與落地', months: [ { name: 'M4', strategy: '強攻Standard與汽車場景展示', actions: ['針對Q1商機，主推Standard方案。', '與風巽達合作，完成「汽車零件製造」場景Demo，並舉辦線上Webinar。'], kpi: 'Standard方案銷售達5套。完成汽車場景Demo錄影。' }, { name: 'M5', strategy: '突破Enterprise與食品場景展示', actions: ['鎖定指標客戶，推動首個Enterprise方案。', '完成「食品包裝」場景Demo與整合穩定性測試。'], kpi: '簽訂首份Enterprise合約。產出穩定性測試報告。' }, { name: 'M6', strategy: '商業推廣與試點部署', actions: ['由業務主導整合方案的商業推廣與合約簽署。', '啟動整合方案的客戶現場試點部署。', '啟動通路(OEM)合作洽談。'], kpi: '簽訂首份整合方案合約。產出試點驗證報告。' } ] },
                q3: { focus: '全面進攻：主打IIoT整合方案，擴大市佔', months: [ { name: 'M7', strategy: '成功案例行銷', actions: ['運用上半年完成的Demo與技術文件，針對汽車零件、食品包裝產業強力推廣Enterprise整合方案。', '製作上半年成功案例，進行精準廣告投放。'], kpi: '整合方案創造5個有效商機。成功案例觸及10,000人次。' }, { name: 'M8', strategy: '高價值方案推廣', actions: ['舉辦第二場線上研討會：「AI與數位雙生如何落地？」，推廣Enterprise整合方案。', '簽訂第一份白牌授權(OEM)合約。'], kpi: 'Enterprise整合方案銷售達4套。簽訂一份白標合約。' }, { name: 'M9', strategy: '季度業績衝刺', actions: ['提供Q3季末限時優惠，主打整合方案價值。', '透過白牌合作夥伴獲取轉介商機。'], kpi: '季度業績達成率100%。夥伴營收貢獻達50萬。' } ] },
                q4: { focus: '鞏固領導地位與明年佈局', months: [ { name: 'M10', strategy: '擴大客戶基礎', actions: ['對潛在客戶進行最後一波補助案推廣。', '向已導入Essential/Standard方案的客戶，推銷升級至Enterprise整合方案。'], kpi: '透過補助案成交5套Essential。完成3個客戶續約升級。' }, { name: 'M11', strategy: '鎖定企業預算', actions: ['強力追蹤Enterprise整合方案商機，協助客戶納入下年度預算。', '拜訪年度重點客戶，收集使用回饋。'], kpi: '確保年度Enterprise 20套目標達成。完成10份客戶訪談。' }, { name: 'M12', strategy: '年度目標達成與總結', actions: ['進行最後合約簽訂與款項催收。', '召開年度業務總結會議，檢討OGSM達成狀況，草擬下年度計畫。'], kpi: '年度總業績達成率100%以上。提出下年度業績增長20%策略草案。' } ] }
            }
        };
        
        // --- DERIVED DATA OBJECTS ---
        let totals = {};
        let goalsData = {};
        let teamPerformanceData = {};

        // --- CHART INSTANCES ---
        let revenueChart, unitsChart, quarterlyPerformanceChart, monthlyPerformanceChart;

        // --- GLOBAL EDIT MODE ---
        const globalEditToggle = document.getElementById('global-edit-toggle');
        globalEditToggle.addEventListener('click', () => {
            const isEditMode = document.body.classList.toggle('edit-mode-active');
            globalEditToggle.textContent = isEditMode ? '完成編輯' : '編輯模式';
            globalEditToggle.classList.toggle('bg-red-600', isEditMode);
            globalEditToggle.classList.toggle('hover:bg-red-700', isEditMode);
            globalEditToggle.classList.toggle('bg-blue-600', !isEditMode);
            globalEditToggle.classList.toggle('hover:bg-blue-700', !isEditMode);
            
            // Toggle contenteditable for all designated elements
            document.querySelectorAll('.editable').forEach(el => {
                el.contentEditable = isEditMode;
            });
            // Re-render the current quarter to apply editability to dynamic content
            const activeQuarterTab = document.querySelector('.quarter-tab.active');
            if (activeQuarterTab) {
                renderQuarterContent(activeQuarterTab.dataset.quarter);
            }
        });

        // --- DATA CALCULATION & UPDATE LOGIC ---
        function calculateAllData() {
            const sum = (arr) => arr.reduce((a, b) => a + b, 0);
            const { goals, revenueDistribution, unitsDistribution } = dataStore.appData;
            totals = {
                revenue: sum(goals.revenue),
                units: sum(goals.units),
                opportunities: sum(goals.opportunities),
                leads: sum(goals.leads),
                quarterly: {
                    revenue: [sum(goals.revenue.slice(0,3)), sum(goals.revenue.slice(3,6)), sum(goals.revenue.slice(6,9)), sum(goals.revenue.slice(9,12))],
                    units: [sum(goals.units.slice(0,3)), sum(goals.units.slice(3,6)), sum(goals.units.slice(6,9)), sum(goals.units.slice(9,12))]
                }
            };
            goalsData = {
                revenue: { labels: ['Essential', 'Standard', 'Enterprise', '加值服務'], data: Object.values(revenueDistribution).map(ratio => totals.revenue * ratio), colors: ['#3b82f6', '#22c55e', '#f59e0b', '#a5b4fc'] },
                units: { labels: ['Essential', 'Standard', 'Enterprise'], data: Object.values(unitsDistribution).map(ratio => totals.units * ratio), colors: ['#8b5cf6', '#14b8a6', '#ec4899'] }
            };
            teamPerformanceData = {
                quarterlyRevenue: { target: totals.quarterly.revenue },
                quarterlyUnits: { target: totals.quarterly.units },
                monthlyRevenue: { target: goals.revenue },
                monthlyUnits: { target: goals.units }
            };
        }
        
        function updateAllVisuals() {
            calculateAllData();
            updateGoalsDOM();
            updateSpreadsheetCalculations();
            redrawAllCharts();
        }

        // --- DOM UPDATE & RENDERING FUNCTIONS ---
        function initializeTextContent() {
            document.querySelectorAll('[data-key-path]').forEach(el => {
                const keyPath = el.dataset.keyPath;
                const value = getObjectValueByPath(keyPath);
                if (value !== undefined) {
                    el.innerHTML = value;
                }
            });
        }

        function updateGoalsDOM() {
            document.getElementById('total-revenue').textContent = Math.round(totals.revenue).toLocaleString();
            document.getElementById('total-units').textContent = Math.round(totals.units).toLocaleString();
            document.getElementById('total-opportunities').textContent = Math.round(totals.opportunities).toLocaleString();
            document.getElementById('total-leads').textContent = Math.round(totals.leads).toLocaleString();
        }

        function renderSpreadsheet() {
            const table = document.getElementById('goal-spreadsheet');
            const metrics = { revenue: '目標業績 (NT$)', units: '目標套數', opportunities: '目標有效商機', leads: '潛在客戶' };
            let html = '<thead><tr><th>指標</th>';
            for (let i = 1; i <= 12; i++) {
                html += `<th>M${i}</th>`;
                if (i % 3 === 0) html += `<th class="quarter-total">Q${i/3}</th>`;
            }
            html += '<th class="annual-total">年度總合</th></tr></thead><tbody>';

            Object.entries(metrics).forEach(([key, name]) => {
                html += `<tr><td class="metric-header">${name}</td>`;
                for (let i = 0; i < 12; i++) {
                    html += `<td><div class="editable p-1 rounded" contenteditable="false" data-key-path="appData.goals.${key}.${i}">${dataStore.appData.goals[key][i].toLocaleString()}</div></td>`;
                    if ((i + 1) % 3 === 0) {
                        html += `<td class="quarter-total" data-q-total-metric="${key}" data-q-index="${Math.floor(i / 3)}"></td>`;
                    }
                }
                html += `<td class="annual-total" data-annual-total-metric="${key}"></td></tr>`;
            });
            html += '</tbody>';
            table.innerHTML = html;
            updateSpreadsheetCalculations();
        }
        
        function updateSpreadsheetCalculations() {
            const metrics = ['revenue', 'units', 'opportunities', 'leads'];
            metrics.forEach(key => {
                for (let i = 0; i < 4; i++) {
                    const qTotal = dataStore.appData.goals[key].slice(i * 3, i * 3 + 3).reduce((a,b) => a+b, 0);
                    const qCell = document.querySelector(`[data-q-total-metric="${key}"][data-q-index="${i}"]`);
                    if(qCell) qCell.textContent = qTotal.toLocaleString();
                }
                const annualTotal = dataStore.appData.goals[key].reduce((a,b) => a+b, 0);
                const annualCell = document.querySelector(`[data-annual-total-metric="${key}"]`);
                if(annualCell) annualCell.textContent = annualTotal.toLocaleString();
            });
        }

        function redrawAllCharts() {
            [revenueChart, unitsChart, quarterlyPerformanceChart, monthlyPerformanceChart].forEach(c => c?.destroy());
            const doughnutOptions = { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.dataset.label === 'NT$' ? 'NT$ ' : ''}${Math.round(c.raw).toLocaleString()}${c.dataset.label !== 'NT$' ? ' 套' : ''}` } } } };
            revenueChart = new Chart(document.getElementById('revenueChart'), { type: 'doughnut', data: { labels: goalsData.revenue.labels, datasets: [{ label: 'NT$', data: goalsData.revenue.data, backgroundColor: goalsData.revenue.colors }] }, options: doughnutOptions });
            unitsChart = new Chart(document.getElementById('unitsChart'), { type: 'doughnut', data: { labels: goalsData.units.labels, datasets: [{ label: '套', data: goalsData.units.data, backgroundColor: goalsData.units.colors }] }, options: doughnutOptions });
            
            const barChartOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { type: 'linear', display: true, position: 'left', beginAtZero: true, title: { display: true, text: '業績 (NT$)' }, ticks: { callback: value => Math.round(value / 10000) + '萬' } }, y1: { type: 'linear', display: true, position: 'right', beginAtZero: true, title: { display: true, text: '套數' }, grid: { drawOnChartArea: false }, ticks: { callback: value => Math.round(value) + '套' } } }, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.dataset.yAxisID === 'y1' ? Math.round(c.raw) + ' 套' : 'NT$ ' + Math.round(c.raw).toLocaleString()}` } } } };
            
            quarterlyPerformanceChart = new Chart(document.getElementById('quarterlyPerformanceChart'), { type: 'bar', data: { labels: ['Q1', 'Q2', 'Q3', 'Q4'], datasets: [{ label: '目標業績', data: teamPerformanceData.quarterlyRevenue.target, backgroundColor: 'rgba(54, 162, 235, 0.5)', yAxisID: 'y' }, { label: '目標套數', data: teamPerformanceData.quarterlyUnits.target, backgroundColor: 'rgba(255, 159, 64, 0.5)', yAxisID: 'y1' }] }, options: barChartOptions });
            monthlyPerformanceChart = new Chart(document.getElementById('monthlyPerformanceChart'), { type: 'bar', data: { labels: Array.from({length: 12}, (_, i) => `M${i+1}`), datasets: [{ label: '目標業績', data: teamPerformanceData.monthlyRevenue.target, backgroundColor: 'rgba(75, 192, 192, 0.5)', yAxisID: 'y' }, { label: '目標套數', data: teamPerformanceData.monthlyUnits.target, backgroundColor: 'rgba(255, 99, 132, 0.5)', yAxisID: 'y1' }] }, options: barChartOptions });
        }
        
        function renderQuarterContent(quarterKey) {
            const data = dataStore.measuresData[quarterKey];
            const quarterIndex = parseInt(quarterKey.replace('q', '')) - 1;
            const isEditMode = document.body.classList.contains('edit-mode-active');
            let contentHTML = `<div class="bg-blue-50 p-4 rounded-lg mb-6 text-center"><h3 class="font-bold text-blue-800">季度重點: <span class="editable p-1 rounded" contenteditable="${isEditMode}" data-key-path="measuresData.${quarterKey}.focus">${data.focus}</span></h3></div><div class="space-y-4">`;
            
            data.months.forEach((month, index) => {
                const monthIndex = quarterIndex * 3 + index;
                const actionsHTML = month.actions.map((action, actionIndex) => `<div class="flex items-start space-x-2 mb-2"><input type="checkbox" class="mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 flex-shrink-0"><p class="editable flex-grow p-1 rounded" contenteditable="${isEditMode}" data-key-path="measuresData.${quarterKey}.months.${index}.actions.${actionIndex}">${action}</p><button type="button" class="remove-action-btn items-center justify-center text-red-500 hover:text-red-700 font-bold text-xl flex-shrink-0 w-6 h-6" data-quarter="${quarterKey}" data-month-index="${index}" data-action-index="${actionIndex}">&times;</button></div>`).join('');
                
                contentHTML += `<div class="month-card border border-gray-200 rounded-lg"><div class="month-header flex items-center p-4 text-left"><div class="flex-grow font-bold flex items-center gap-2"><span>${month.name} -</span><span class="editable p-1 rounded" contenteditable="${isEditMode}" data-key-path="measuresData.${quarterKey}.months.${index}.strategy">${month.strategy}</span></div></div><div class="p-4 pt-2 grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-gray-50 p-3 rounded"><h4 class="font-semibold text-sm text-gray-500 mb-2">具體執行方案</h4><div class="actions-list">${actionsHTML}</div><button type="button" class="add-action-btn mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold" data-quarter="${quarterKey}" data-month-index="${index}">+ 新增執行項目</button></div><div class="bg-gray-50 p-3 rounded flex flex-col"><h4 class="font-semibold text-sm text-gray-500 mb-2">檢核指標</h4><textarea class="editable w-full p-2 rounded border-transparent text-sm flex-grow bg-transparent" ${isEditMode ? '' : 'readonly'} data-key-path="measuresData.${quarterKey}.months.${index}.kpi" style="resize: none;">${month.kpi}</textarea><div class="mt-3 pt-3 border-t border-gray-200 text-xs text-gray-600 space-y-1"><p><strong>當月目標:</strong></p><p class="pl-2">業績: <span class="font-semibold text-green-700">NT$ ${dataStore.appData.goals.revenue[monthIndex].toLocaleString()}</span></p><p class="pl-2">套數: <span class="font-semibold text-blue-700">${dataStore.appData.goals.units[monthIndex].toLocaleString()} 套</span></p></div></div></div><div class="px-4 pb-4 flex items-center justify-end"><button class="ai-assistant-btn bg-blue-500 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-1" data-quarter="${quarterKey}" data-month-index="${index}">✨ AI 業務助理</button></div></div>`;
            });
            contentHTML += `</div>`;
            document.getElementById('measures-content').innerHTML = contentHTML;
        }

        // --- EVENT LISTENERS & HANDLERS ---
        function attachUniversalListeners() {
            // Auto-save for all editable elements
            document.body.addEventListener('blur', (e) => {
                if (e.target.matches('.editable[contenteditable], .editable[readonly=""]')) {
                    const keyPath = e.target.dataset.keyPath;
                    if (!keyPath) return;
                    const value = e.target.matches('div, p, span, h1, h2, h3') ? e.target.innerHTML.trim() : e.target.value.trim();
                    setObjectValueByPath(keyPath, value);
                    if (keyPath.startsWith('appData.goals')) {
                        const numericValue = parseFloat(value.replace(/[^0-9.]/g, '') || 0);
                        e.target.textContent = numericValue.toLocaleString();
                        updateAllVisuals();
                    }
                }
            }, true);
            document.body.addEventListener('input', (e) => {
                 if (e.target.matches('textarea.editable')) {
                    const keyPath = e.target.dataset.keyPath;
                    if(keyPath) setObjectValueByPath(keyPath, e.target.value);
                }
            });
             document.body.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.matches('.editable[contenteditable="true"]')) {
                    e.preventDefault();
                    e.target.blur();
                }
            });

            // Navigation
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.content-section');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        navLinks.forEach(link => link.classList.toggle('active', link.getAttribute('href') === '#' + entry.target.id));
                    }
                });
            }, { rootMargin: '-40% 0px -60% 0px' });
            sections.forEach(section => observer.observe(section));
            navLinks.forEach(anchor => anchor.addEventListener('click', (e) => { e.preventDefault(); document.querySelector(anchor.getAttribute('href')).scrollIntoView({ behavior: 'smooth' }); }));

            // Measures Section Dynamic Listeners
            const measuresContainer = document.getElementById('measures-content');
            measuresContainer.addEventListener('click', (e) => {
                if (e.target.matches('.add-action-btn')) {
                    const { quarter, monthIndex } = e.target.dataset;
                    dataStore.measuresData[quarter].months[monthIndex].actions.push('新的執行項目');
                    renderQuarterContent(quarter);
                }
                if (e.target.matches('.remove-action-btn')) {
                    const { quarter, monthIndex, actionIndex } = e.target.dataset;
                    dataStore.measuresData[quarter].months[monthIndex].actions.splice(actionIndex, 1);
                    renderQuarterContent(quarter);
                }
                const aiBtn = e.target.closest('.ai-assistant-btn');
                if (aiBtn) {
                    const { quarter, monthIndex } = aiBtn.dataset;
                    openAIAssistantModal(quarter, monthIndex);
                }
            });

            // Quarter Tabs
            document.getElementById('quarter-tabs-container').addEventListener('click', (e) => {
                if (e.target.matches('.quarter-tab')) {
                    document.querySelectorAll('.quarter-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    renderQuarterContent(e.target.dataset.quarter);
                }
            });
        }

        // --- DATA UTILITIES ---
        function getObjectValueByPath(path) {
            return path.split('.').reduce((acc, part) => acc && acc[part], dataStore);
        }

        function setObjectValueByPath(path, value) {
            const keys = path.split('.');
            let obj = dataStore;
            for (let i = 0; i < keys.length - 1; i++) {
                obj = obj[keys[i]];
                if (typeof obj === 'undefined') return;
            }
            const finalKey = keys[keys.length - 1];
            const oldValue = obj[finalKey];
            if (typeof oldValue === 'number') {
                obj[finalKey] = parseFloat(value.replace(/[^0-9.]/g, '') || 0);
            } else {
                obj[finalKey] = value;
            }
        }

        // --- Gemini API Integration ---
        const modal = document.getElementById('gemini-modal');
        const modalTitle = document.getElementById('gemini-modal-title');
        const modalContent = document.getElementById('gemini-modal-content');
        const modalLoader = document.getElementById('gemini-modal-loader');
        modal.addEventListener('click', (e) => { if (e.target.matches('#gemini-modal, #gemini-modal-close')) modal.classList.remove('show'); });

        async function callGemini(prompt) {
            modalContent.innerHTML = '';
            modalLoader.style.display = 'block';
            modal.classList.add('show');
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] }) });
                if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    modalContent.innerHTML = marked.parse(result.candidates[0].content.parts[0].text);
                } else {
                    modalContent.textContent = '抱歉，AI 無法生成回應。';
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                modalContent.textContent = `發生錯誤：${error.message}`;
            } finally {
                modalLoader.style.display = 'none';
            }
        }

        function openAIAssistantModal(quarterKey, monthIndex) {
            const monthData = dataStore.measuresData[quarterKey].months[monthIndex];
            const monthGlobalIndex = (parseInt(quarterKey.replace('q', '')) - 1) * 3 + parseInt(monthIndex);
            const context = {
                ...monthData,
                monthRevenue: dataStore.appData.goals.revenue[monthGlobalIndex],
                monthUnits: dataStore.appData.goals.units[monthGlobalIndex]
            };
            modalTitle.textContent = `AI 業務助理 (${context.name})`;
            const prompt = `你是一位專業的業務策略顧問與文案寫手。請根據以下 ${context.name} 的業務計畫內容，提供具體的協助。\n\n### ${context.name} 計畫摘要\n- **核心策略:** ${context.strategy}\n- **當月目標:** 業績 NT$ ${context.monthRevenue.toLocaleString()}, 銷售 ${context.monthUnits} 套\n- **具體執行方案:**\n  ${context.actions.map(a => `- ${a}`).join('\n')}\n- **檢核指標 (KPI):** ${context.kpi}\n\n### 你的任務\n請根據以上資訊，提供 2-3 個具體的、可執行的建議或文案草稿，以協助業務團隊達成目標。思考方向可以包含：\n1.  **行動建議:** 針對「執行方案」，提出更細緻、更有創意的作法。\n2.  **文案草稿:** 針對需要對外溝通的項目（如研討會、客戶Email、社群貼文），提供吸引人的文案草稿。\n3.  **風險提示:** 點出潛在的挑戰，並提出應對建議。\n\n請以專業、條理分明的格式呈現你的建議。`;
            callGemini(prompt);
        }

        document.getElementById('ai-analyst-btn').addEventListener('click', () => {
            modalTitle.textContent = `AI 績效洞察 (團隊總覽)`;
            const prompt = `你是一位頂尖的數據分析師與業務總監。請分析以下「團隊總覽」的 2025 年度業務目標數據，並提供精闢的洞察與策略建議。\n\n### 年度總目標\n- **總業績:** NT$ ${Math.round(totals.revenue).toLocaleString()}\n- **總套數:** ${Math.round(totals.units)} 套\n\n### 團隊目標數據\n- **每月業績目標 (NT$):** ${teamPerformanceData.monthlyRevenue.target.map(r => r.toLocaleString()).join(', ')}\n- **每月套數目標:** ${teamPerformanceData.monthlyUnits.target.map(u => Math.round(u)).join(', ')}\n\n### 你的任務\n請根據以上數據，生成一份簡潔的分析報告，包含以下幾點：\n1.  **趨勢總結:** 描述全年度業績與套數目標的增長趨勢。是否有明顯的高峰或低谷期？\n2.  **關鍵季度分析:** 哪個季度是達成年度目標的關鍵？該季度的挑戰可能在哪裡？\n3.  **策略建議:** 基於數據趨勢，提出 2-3 點策略建議。\n4.  **潛在風險:** 點出潛在的風險，並建議應對措施。\n\n請以專業、數據驅動的口吻，提供清晰、可執行的洞察。`;
            callGemini(prompt);
        });

        // --- SAVE AS NEW VERSION ---
        document.getElementById('save-as-version-btn').addEventListener('click', () => {
            if (document.body.classList.contains('edit-mode-active')) {
                globalEditToggle.click(); // Exit edit mode to ensure UI is clean
            }
            const clonedDoc = document.documentElement.cloneNode(true);
            const scriptTag = clonedDoc.querySelector('script:not([src])');
            if (scriptTag) {
                // Replace the initial dataStore declaration with the current, modified state.
                let scriptContent = scriptTag.innerHTML;
                scriptContent = scriptContent.replace(
                    /let dataStore = \{[\s\S]*?};/, 
                    `let dataStore = ${JSON.stringify(dataStore, null, 4)};`
                );
                scriptTag.innerHTML = scriptContent;
            }
            const newTitle = (dataStore.textData.mainTitle.trim() || 'OGSM計畫') + " (互動式副本).html";
            const htmlString = '<!DOCTYPE html>\n' + clonedDoc.outerHTML;
            const blob = new Blob([htmlString], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = newTitle;
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
        });
        
        // --- INITIALIZATION ---
        function initialize() {
            updateAllVisuals();
            initializeTextContent();
            renderSpreadsheet();
            attachUniversalListeners();
            document.querySelector('.quarter-tab[data-quarter="q1"]').click();
        }

        initialize();
    });
    </script>
</body>
</html>
