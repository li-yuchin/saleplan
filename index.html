<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“ç¢¼è³‡è¨Š MES BOX å¹´åº¦æ¥­å‹™éŠ·å”®è¨ˆåŠƒ (OGSM) v6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f4f7f9;
        }
        .nav-link {
            transition: color 0.3s, border-bottom-color 0.3s;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active, .nav-link:hover {
            color: #1d4ed8;
            border-bottom-color: #1d4ed8;
        }
        .content-section {
            scroll-margin-top: 80px;
        }
        .ogsm-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
            border: 1px solid #e5e7eb;
        }
        .quarter-tab.active {
            background-color: #1d4ed8;
            color: white;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            max-width: 300px;
            margin: auto;
        }
        .dashboard-chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }
        .gemini-modal { display: none; }
        .gemini-modal.show { display: flex; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- å…¨å±€ç·¨è¼¯æ¨¡å¼æ¨£å¼ --- */
        .editable {
            transition: box-shadow 0.2s, background-color 0.2s;
        }
        body.edit-mode-active .editable {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
            background-color: #eff6ff;
            border-radius: 0.25rem;
        }
        body.edit-mode-active .add-action-btn,
        body.edit-mode-active .remove-action-btn {
            display: inline-flex;
        }
        .add-action-btn, .remove-action-btn {
            display: none;
        }

        /* --- è©¦ç®—è¡¨æ¨£å¼ --- */
        .spreadsheet-table th, .spreadsheet-table td {
            padding: 0.5rem;
            text-align: right;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        .spreadsheet-table th { background-color: #f9fafb; font-weight: 600; }
        .spreadsheet-table .metric-header { text-align: left; font-weight: 600; }
        .spreadsheet-table .quarter-total, .spreadsheet-table .annual-total { background-color: #f3f4f6; font-weight: 700; }
        
        /* --- AI Modal Content Styling --- */
        #gemini-modal-content h1, #gemini-modal-content h2, #gemini-modal-content h3 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        #gemini-modal-content h1 { font-size: 1.5em; }
        #gemini-modal-content h2 { font-size: 1.25em; }
        #gemini-modal-content h3 { font-size: 1.1em; }
        #gemini-modal-content ul, #gemini-modal-content ol { margin-left: 1.5rem; margin-bottom: 1em; }
        #gemini-modal-content ul { list-style-type: disc; }
        #gemini-modal-content ol { list-style-type: decimal; }
        #gemini-modal-content p { margin-bottom: 0.75em; line-height: 1.6; }
        #gemini-modal-content strong { font-weight: bold; }
        #gemini-modal-content code { background-color: #e5e7eb; padding: 0.1rem 0.3rem; border-radius: 0.25rem; font-family: monospace; }
    </style>
</head>
<body class="text-gray-900">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-2 md:gap-4">
                    <h1 id="main-title" class="text-xl md:text-2xl font-black p-1 rounded editable" contenteditable="false" data-key-path="textData.mainTitle"></h1>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <nav class="hidden md:flex items-center space-x-4 lg:space-x-6 text-sm lg:text-base">
                        <a href="#objective" class="nav-link font-semibold">ç›®æ¨™ (O)</a>
                        <a href="#goals" class="nav-link font-semibold">æŒ‡æ¨™ (G)</a>
                        <a href="#strategies" class="nav-link font-semibold">ç­–ç•¥ (S)</a>
                        <a href="#analysis" class="nav-link font-semibold">æ•¸æ“šåˆ†æ</a>
                        <a href="#measures" class="nav-link font-semibold">åŸ·è¡Œæ–¹æ¡ˆ (M)</a>
                    </nav>
                    <button id="save-as-version-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors whitespace-nowrap">å¦å­˜æ–°ç‰ˆ</button>
                    <button id="global-edit-toggle" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors whitespace-nowrap">ç·¨è¼¯æ¨¡å¼</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-12">
        <!-- Objective -->
        <section id="objective" class="content-section text-center mb-16">
            <div class="ogsm-card p-8">
                <h2 class="text-sm font-bold uppercase text-blue-600 tracking-widest mb-4">OBJECTIVE (çµ‚æ¥µç›®æ¨™)</h2>
                <p id="objective-text" class="text-2xl md:text-3xl font-bold max-w-4xl mx-auto p-2 rounded editable" contenteditable="false" data-key-path="textData.objective"></p>
            </div>
        </section>

        <!-- Goals -->
        <section id="goals" class="content-section mb-16">
            <div class="text-center mb-4">
                 <h2 id="goals-title" class="text-3xl font-bold p-1 rounded editable" contenteditable="false" data-key-path="textData.goalsTitle"></h2>
                <p id="goals-subtitle" class="text-gray-600 mt-2 p-1 rounded editable" contenteditable="false" data-key-path="textData.goalsSubtitle"></p>
            </div>
            <div class="ogsm-card p-6 mb-10">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="text-center"><p class="text-gray-500">å¹´åº¦ç¸½æ¥­ç¸¾</p><p class="text-4xl font-extrabold text-green-600 my-2">NT$ <span id="total-revenue"></span></p></div>
                    <div class="text-center"><p class="text-gray-500">å¹´åº¦ç¸½éŠ·å”®å¥—æ•¸</p><p class="text-4xl font-extrabold text-blue-600 my-2"><span id="total-units"></span> å¥—</p></div>
                    <div class="text-center"><p class="text-gray-500">å¹´åº¦æœ‰æ•ˆå•†æ©Ÿ</p><p class="text-4xl font-extrabold text-yellow-600 my-2"><span id="total-opportunities"></span> ä»¶</p></div>
                    <div class="text-center"><p class="text-gray-500">å¹´åº¦æ½›åœ¨å®¢æˆ¶</p><p class="text-4xl font-extrabold text-purple-600 my-2"><span id="total-leads"></span> ç­†</p></div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="ogsm-card p-6"><h3 class="font-bold text-lg text-center mb-4">æ¥­ç¸¾ç›®æ¨™æ§‹æˆ</h3><div class="chart-container"><canvas id="revenueChart"></canvas></div></div>
                <div class="ogsm-card p-6"><h3 class="font-bold text-lg text-center mb-4">éŠ·å”®å¥—æ•¸ç›®æ¨™æ§‹æˆ</h3><div class="chart-container"><canvas id="unitsChart"></canvas></div></div>
            </div>
        </section>

        <!-- Strategies -->
        <section id="strategies" class="content-section mb-16">
            <div class="text-center mb-10">
                <h2 id="strategies-title" class="text-3xl font-bold p-1 rounded editable" contenteditable="false" data-key-path="textData.strategiesTitle"></h2>
                <p id="strategies-subtitle" class="text-gray-600 mt-2 p-1 rounded editable" contenteditable="false" data-key-path="textData.strategiesSubtitle"></p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="ogsm-card p-6"><h3 class="font-bold text-xl mb-2 p-1 rounded editable" contenteditable="false" data-key-path="textData.s1Title"></h3><p class="text-gray-600 p-1 rounded editable" contenteditable="false" data-key-path="textData.s1Desc"></p></div>
                <div class="ogsm-card p-6"><h3 class="font-bold text-xl mb-2 p-1 rounded editable" contenteditable="false" data-key-path="textData.s2Title"></h3><p class="text-gray-600 p-1 rounded editable" contenteditable="false" data-key-path="textData.s2Desc"></p></div>
                <div class="ogsm-card p-6"><h3 class="font-bold text-xl mb-2 p-1 rounded editable" contenteditable="false" data-key-path="textData.s3Title"></h3><p class="text-gray-600 p-1 rounded editable" contenteditable="false" data-key-path="textData.s3Desc"></p></div>
                <div class="ogsm-card p-6"><h3 class="font-bold text-xl mb-2 p-1 rounded editable" contenteditable="false" data-key-path="textData.s4Title"></h3><p class="text-gray-600 p-1 rounded editable" contenteditable="false" data-key-path="textData.s4Desc"></p></div>
            </div>
            <div class="ogsm-card p-6 mt-8 bg-blue-50 border-blue-200">
                <h3 class="font-bold text-xl mb-2 text-blue-800 p-1 rounded editable" contenteditable="false" data-key-path="textData.coreStrategyTitle"></h3>
                <p class="text-blue-700 p-1 rounded editable" contenteditable="false" data-key-path="textData.coreStrategyDesc"></p>
            </div>
        </section>

        <!-- Data Analysis -->
        <section id="analysis" class="content-section mb-16">
            <div class="text-center mb-10"><h2 class="text-3xl font-bold">ç›®æ¨™æ•¸æ“šåˆ†æ</h2><p class="text-gray-600 mt-2">å°‡å¹´åº¦ç¸½ç›®æ¨™åˆ†è§£è‡³åœ˜éšŠæˆå“¡ï¼Œä¸¦ä»¥è¦–è¦ºåŒ–åœ–è¡¨è¿½è¹¤ç¸¾æ•ˆ</p></div>
            <div class="ogsm-card p-6 md:p-8 space-y-12">
                <div>
                    <h3 class="font-bold text-xl mb-4">ç›®æ¨™è¦åŠƒè©¦ç®—è¡¨</h3>
                    <div class="overflow-x-auto"><table id="goal-spreadsheet" class="w-full text-sm spreadsheet-table"></table></div>
                </div>
                <div>
                    <div class="flex flex-wrap items-center justify-between mb-6">
                        <h3 class="font-bold text-xl mb-4 sm:mb-0">åœ˜éšŠç¸¾æ•ˆå„€è¡¨æ¿</h3>
                        <button id="ai-analyst-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2">âœ¨ ç”ŸæˆAIæ´å¯Ÿ</button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="lg:col-span-2 ogsm-card p-4"><h4 class="font-semibold text-center mb-2">åœ˜éšŠå­£åº¦æ¥­ç¸¾èˆ‡å¥—æ•¸ç›®æ¨™</h4><div class="dashboard-chart-container"><canvas id="quarterlyPerformanceChart"></canvas></div></div>
                        <div class="lg:col-span-2 ogsm-card p-4"><h4 class="font-semibold text-center mb-2">åœ˜éšŠæœˆåº¦æ¥­ç¸¾èˆ‡å¥—æ•¸ç›®æ¨™è¶¨å‹¢</h4><div class="dashboard-chart-container"><canvas id="monthlyPerformanceChart"></canvas></div></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Measures -->
        <section id="measures" class="content-section mb-16">
            <div class="text-center mb-10"><h2 class="text-3xl font-bold">åŸ·è¡Œæ–¹æ¡ˆ (Measures)</h2><p class="text-gray-600 mt-2">å°‡å¹´åº¦è¨ˆç•«æ‹†è§£ç‚ºå­£åº¦èˆ‡æœˆä»½ï¼Œç¢ºä¿ç­–ç•¥çš„æœ‰æ•ˆåŸ·è¡Œèˆ‡å³æ™‚èª¿æ•´</p></div>
            <div class="ogsm-card p-6 md:p-8">
                <div id="quarter-tabs-container" class="flex flex-wrap justify-center border-b border-gray-200 mb-6">
                    <button data-quarter="q1" class="quarter-tab text-lg font-semibold py-3 px-4 md:px-6 -mb-px border-b-2 border-transparent">ç¬¬ä¸€å­£åº¦ (Q1)</button>
                    <button data-quarter="q2" class="quarter-tab text-lg font-semibold py-3 px-4 md:px-6 -mb-px border-b-2 border-transparent">ç¬¬äºŒå­£åº¦ (Q2)</button>
                    <button data-quarter="q3" class="quarter-tab text-lg font-semibold py-3 px-4 md:px-6 -mb-px border-b-2 border-transparent">ç¬¬ä¸‰å­£åº¦ (Q3)</button>
                    <button data-quarter="q4" class="quarter-tab text-lg font-semibold py-3 px-4 md:px-6 -mb-px border-b-2 border-transparent">ç¬¬å››å­£åº¦ (Q4)</button>
                </div>
                <div id="measures-content"></div>
            </div>
        </section>
    </main>

    <footer class="text-center py-8 mt-12 text-gray-500"><p>å“ç¢¼è³‡è¨Šè‚¡ä»½æœ‰é™å…¬å¸ | 2025å¹´åº¦æ¥­å‹™éŠ·å”®è¨ˆåŠƒ</p></footer>

    <!-- Gemini API Modal -->
    <div id="gemini-modal" class="gemini-modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b"><h3 id="gemini-modal-title" class="text-xl font-bold">AI åŠ©ç†</h3><button id="gemini-modal-close" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div>
            <div id="gemini-modal-content" class="p-6 overflow-y-auto prose"></div>
            <div id="gemini-modal-loader" class="p-6 text-center hidden"><div class="spinner mx-auto"></div><p class="mt-4 text-gray-600">AI ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...</p></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- DATA STORE (SINGLE SOURCE OF TRUTH) ---
        // These objects hold the entire state of the application.
        let dataStore = {
            textData: {
                mainTitle: "MES BOX 2025 æ¥­å‹™éŠ·å”®è¨ˆåŠƒ v6",
                objective: "æˆç‚ºå°ç£ä¸­å°è£½é€ æ¥­åœ¨æ™ºæ…§è½‰å‹å¸‚å ´ä¸­ï¼Œé¦–é¸çš„MESè§£æ±ºæ–¹æ¡ˆé ˜å°å“ç‰Œï¼Œä¸¦ä»¥ã€ŒMES BOXã€ä½œç‚ºå¯¦ç¾å·¥å» æ•¸ä½åŒ–ã€é€æ˜åŒ–çš„æœ€ä½³å…¥é–€ç”¢å“ã€‚",
                goalsTitle: "å…·é«”ç›®æ¨™ (Goals)",
                goalsSubtitle: "ä»¥3äººæ¥­å‹™åœ˜éšŠï¼Œé”æˆä»¥ä¸‹å¹´åº¦é‡åŒ–ç›®æ¨™",
                strategiesTitle: "ç­–ç•¥ (Strategies)",
                strategiesSubtitle: "ç‚ºé”æˆç›®æ¨™ï¼Œæˆ‘å€‘å°‡æ¨è¡Œå››å¤§æ ¸å¿ƒç­–ç•¥",
                s1Title: "S1: ç”¢å“çµ„åˆèˆ‡åƒ¹å€¼å®šä½", s1Desc: "é‡å°ä¸åŒè¦æ¨¡èˆ‡éœ€æ±‚çš„å®¢æˆ¶ï¼Œç²¾æº–æ¨å»£å°æ‡‰çš„æ–¹æ¡ˆçµ„åˆï¼Œæœ€å¤§åŒ–å¸‚å ´è¦†è“‹ç‡èˆ‡ç‡Ÿæ”¶ã€‚",
                s2Title: "S2: å¸‚å ´æ·±è€•èˆ‡é€šè·¯æ‹“å±•", s2Desc: "é–å®šé«˜æ½›åŠ›ç”¢æ¥­é€²è¡Œæ·±åº¦é–‹ç™¼ï¼Œä¸¦å•Ÿå‹•ç™½ç‰Œæˆæ¬Š(OEM)è¨ˆç•«ï¼Œæ‹“å±•å¤šå…ƒéŠ·å”®é€šè·¯ã€‚",
                s3Title: "S3: é¡§å•å¼éŠ·å”®èˆ‡å…§å®¹è¡ŒéŠ·", s3Desc: "é‹ç”¨ç™½çš®æ›¸èˆ‡ç”¢æ¥­åˆ†æå…§å®¹ï¼Œå°‡æ¥­å‹™åœ˜éšŠå®šä½ç‚ºã€Œæ™ºæ…§è£½é€ é¡§å•ã€ï¼Œé€éæ•™è‚²å¸‚å ´ä¾†å‰µé€ éœ€æ±‚ã€‚",
                s4Title: "S4: åœ˜éšŠè³¦èƒ½èˆ‡ç¸¾æ•ˆç®¡ç†", s4Desc: "å»ºç«‹æ¸…æ™°çš„åŸ·è¡Œæ–¹æ¡ˆèˆ‡æª¢æ ¸æŒ‡æ¨™ï¼Œè³¦èƒ½åœ˜éšŠé”æˆç›®æ¨™ä¸¦æŒçºŒå„ªåŒ–ã€‚",
                coreStrategyTitle: "ğŸš€ æ ¸å¿ƒè³¦èƒ½ç­–ç•¥: IIoT/SCADA æ•´åˆæ–¹æ¡ˆ", coreStrategyDesc: "èˆ‡ **é¢¨å·½é”ç§‘æŠ€** åˆä½œï¼Œå…±åŒé–‹ç™¼ IIoT/SCADA èˆ‡é›²ç«¯ MES çš„æ•´åˆè§£æ±ºæ–¹æ¡ˆã€‚æ­¤åˆä½œå°‡å¤§å¹…å¼·åŒ– **Enterprise ä¼æ¥­ç‰ˆ** çš„ç”¢å“ç«¶çˆ­åŠ›ï¼Œç‚ºä¸‹åŠå¹´çš„é«˜åƒ¹å€¼å¸‚å ´å®¢æˆ¶æä¾›å¾æ•¸æ“šæ¡é›†åˆ°è£½é€ åŸ·è¡Œçš„å®Œæ•´æ–¹æ¡ˆï¼Œæ˜¯é”æˆå¹´åº¦ç›®æ¨™çš„é—œéµå¼•æ“ã€‚"
            },
            appData: {
                goals: {
                    revenue: [1000000, 1500000, 2000000, 2200000, 2500000, 2800000, 2600000, 2600000, 2800000, 3300000, 3300000, 3400000],
                    units: [7, 7, 6, 9, 9, 9, 8, 8, 9, 10, 9, 10],
                    opportunities: [20, 20, 25, 25, 25, 25, 25, 25, 25, 30, 25, 25],
                    leads: [100, 120, 130, 120, 130, 120, 130, 120, 130, 150, 120, 130]
                },
                revenueDistribution: { essential: 0.33, standard: 0.298, enterprise: 0.3253, valueAdd: 0.0467 },
                unitsDistribution: { essential: 0.5, standard: 0.3, enterprise: 0.2 },
            },
            measuresData: {
                q1: { focus: 'åŸºç¤å»ºè¨­ã€å¸‚å ´é ç†± æš¨ æ•´åˆæ–¹æ¡ˆå•Ÿå‹•', months: [ { name: 'M1', strategy: 'å…§éƒ¨è³¦èƒ½èˆ‡æ•´åˆæ–¹æ¡ˆå•Ÿå‹•', actions: ['æ¥­å‹™åœ˜éšŠå…§éƒ¨è³¦èƒ½ï¼Œå®Œæˆç”¢å“æ¸¬é©—ã€‚', 'èˆ‡é¢¨å·½é”åˆä½œï¼Œå•Ÿå‹•æ•´åˆæ–¹æ¡ˆéœ€æ±‚åˆ†æèˆ‡APIè¨­è¨ˆã€‚'], kpi: 'ç”¢å‡ºéœ€æ±‚è¦æ ¼æ›¸èˆ‡SCADAâ†’MESä»‹é¢è¨­è¨ˆæ–‡ä»¶ã€‚' }, { name: 'M2', strategy: 'å…§å®¹è¡ŒéŠ·èˆ‡åŸå‹é–‹ç™¼', actions: ['æ¨å»£Essentialæ–¹æ¡ˆèˆ‡æ”¿åºœè£œåŠ©æ¡ˆã€‚', 'åˆä½œé€²è¡ŒIIoT+MESåŸå‹é–‹ç™¼èˆ‡ç’°å¢ƒå»ºç½®ã€‚'], kpi: 'æˆåŠŸåª’åˆ5å€‹è£œåŠ©æ¡ˆã€‚å®ŒæˆSCADAåŸå‹èˆ‡MES APIæ–‡æª”ã€‚' }, { name: 'M3', strategy: 'ç·šä¸Šé ç†±èˆ‡æ•´åˆæ¸¬è©¦', actions: ['èˆ‰è¾¦ã€Œè§£é–å·¥å» æ•¸æ“šåŠ›ã€ç·šä¸Šç ”è¨æœƒã€‚', 'å®Œæˆè³‡æ–™ä¸²æ¥èˆ‡é›™å‘æ¸¬è©¦ï¼Œä¸¦ç™¼é€è»Ÿå•Ÿå‹•é‚€è«‹å‡½ã€‚'], kpi: 'ç ”è¨æœƒå ±å80äººã€‚ç”¢å‡ºä¸²æ¥æ¸¬è©¦å ±å‘Šã€‚' } ] },
                q2: { focus: 'ä¸»åŠ›æ–¹æ¡ˆéŠ·å”® æš¨ æ•´åˆæ–¹æ¡ˆå±•ç¤ºèˆ‡è½åœ°', months: [ { name: 'M4', strategy: 'å¼·æ”»Standardèˆ‡æ±½è»Šå ´æ™¯å±•ç¤º', actions: ['é‡å°Q1å•†æ©Ÿï¼Œä¸»æ¨Standardæ–¹æ¡ˆã€‚', 'èˆ‡é¢¨å·½é”åˆä½œï¼Œå®Œæˆã€Œæ±½è»Šé›¶ä»¶è£½é€ ã€å ´æ™¯Demoï¼Œä¸¦èˆ‰è¾¦ç·šä¸ŠWebinarã€‚'], kpi: 'Standardæ–¹æ¡ˆéŠ·å”®é”5å¥—ã€‚å®Œæˆæ±½è»Šå ´æ™¯DemoéŒ„å½±ã€‚' }, { name: 'M5', strategy: 'çªç ´Enterpriseèˆ‡é£Ÿå“å ´æ™¯å±•ç¤º', actions: ['é–å®šæŒ‡æ¨™å®¢æˆ¶ï¼Œæ¨å‹•é¦–å€‹Enterpriseæ–¹æ¡ˆã€‚', 'å®Œæˆã€Œé£Ÿå“åŒ…è£ã€å ´æ™¯Demoèˆ‡æ•´åˆç©©å®šæ€§æ¸¬è©¦ã€‚'], kpi: 'ç°½è¨‚é¦–ä»½Enterpriseåˆç´„ã€‚ç”¢å‡ºç©©å®šæ€§æ¸¬è©¦å ±å‘Šã€‚' }, { name: 'M6', strategy: 'å•†æ¥­æ¨å»£èˆ‡è©¦é»éƒ¨ç½²', actions: ['ç”±æ¥­å‹™ä¸»å°æ•´åˆæ–¹æ¡ˆçš„å•†æ¥­æ¨å»£èˆ‡åˆç´„ç°½ç½²ã€‚', 'å•Ÿå‹•æ•´åˆæ–¹æ¡ˆçš„å®¢æˆ¶ç¾å ´è©¦é»éƒ¨ç½²ã€‚', 'å•Ÿå‹•é€šè·¯(OEM)åˆä½œæ´½è«‡ã€‚'], kpi: 'ç°½è¨‚é¦–ä»½æ•´åˆæ–¹æ¡ˆåˆç´„ã€‚ç”¢å‡ºè©¦é»é©—è­‰å ±å‘Šã€‚' } ] },
                q3: { focus: 'å…¨é¢é€²æ”»ï¼šä¸»æ‰“IIoTæ•´åˆæ–¹æ¡ˆï¼Œæ“´å¤§å¸‚ä½”', months: [ { name: 'M7', strategy: 'æˆåŠŸæ¡ˆä¾‹è¡ŒéŠ·', actions: ['é‹ç”¨ä¸ŠåŠå¹´å®Œæˆçš„Demoèˆ‡æŠ€è¡“æ–‡ä»¶ï¼Œé‡å°æ±½è»Šé›¶ä»¶ã€é£Ÿå“åŒ…è£ç”¢æ¥­å¼·åŠ›æ¨å»£Enterpriseæ•´åˆæ–¹æ¡ˆã€‚', 'è£½ä½œä¸ŠåŠå¹´æˆåŠŸæ¡ˆä¾‹ï¼Œé€²è¡Œç²¾æº–å»£å‘ŠæŠ•æ”¾ã€‚'], kpi: 'æ•´åˆæ–¹æ¡ˆå‰µé€ 5å€‹æœ‰æ•ˆå•†æ©Ÿã€‚æˆåŠŸæ¡ˆä¾‹è§¸åŠ10,000äººæ¬¡ã€‚' }, { name: 'M8', strategy: 'é«˜åƒ¹å€¼æ–¹æ¡ˆæ¨å»£', actions: ['èˆ‰è¾¦ç¬¬äºŒå ´ç·šä¸Šç ”è¨æœƒï¼šã€ŒAIèˆ‡æ•¸ä½é›™ç”Ÿå¦‚ä½•è½åœ°ï¼Ÿã€ï¼Œæ¨å»£Enterpriseæ•´åˆæ–¹æ¡ˆã€‚', 'ç°½è¨‚ç¬¬ä¸€ä»½ç™½ç‰Œæˆæ¬Š(OEM)åˆç´„ã€‚'], kpi: 'Enterpriseæ•´åˆæ–¹æ¡ˆéŠ·å”®é”4å¥—ã€‚ç°½è¨‚ä¸€ä»½ç™½æ¨™åˆç´„ã€‚' }, { name: 'M9', strategy: 'å­£åº¦æ¥­ç¸¾è¡åˆº', actions: ['æä¾›Q3å­£æœ«é™æ™‚å„ªæƒ ï¼Œä¸»æ‰“æ•´åˆæ–¹æ¡ˆåƒ¹å€¼ã€‚', 'é€éç™½ç‰Œåˆä½œå¤¥ä¼´ç²å–è½‰ä»‹å•†æ©Ÿã€‚'], kpi: 'å­£åº¦æ¥­ç¸¾é”æˆç‡100%ã€‚å¤¥ä¼´ç‡Ÿæ”¶è²¢ç»é”50è¬ã€‚' } ] },
                q4: { focus: 'éå›ºé ˜å°åœ°ä½èˆ‡æ˜å¹´ä½ˆå±€', months: [ { name: 'M10', strategy: 'æ“´å¤§å®¢æˆ¶åŸºç¤', actions: ['å°æ½›åœ¨å®¢æˆ¶é€²è¡Œæœ€å¾Œä¸€æ³¢è£œåŠ©æ¡ˆæ¨å»£ã€‚', 'å‘å·²å°å…¥Essential/Standardæ–¹æ¡ˆçš„å®¢æˆ¶ï¼Œæ¨éŠ·å‡ç´šè‡³Enterpriseæ•´åˆæ–¹æ¡ˆã€‚'], kpi: 'é€éè£œåŠ©æ¡ˆæˆäº¤5å¥—Essentialã€‚å®Œæˆ3å€‹å®¢æˆ¶çºŒç´„å‡ç´šã€‚' }, { name: 'M11', strategy: 'é–å®šä¼æ¥­é ç®—', actions: ['å¼·åŠ›è¿½è¹¤Enterpriseæ•´åˆæ–¹æ¡ˆå•†æ©Ÿï¼Œå”åŠ©å®¢æˆ¶ç´å…¥ä¸‹å¹´åº¦é ç®—ã€‚', 'æ‹œè¨ªå¹´åº¦é‡é»å®¢æˆ¶ï¼Œæ”¶é›†ä½¿ç”¨å›é¥‹ã€‚'], kpi: 'ç¢ºä¿å¹´åº¦Enterprise 20å¥—ç›®æ¨™é”æˆã€‚å®Œæˆ10ä»½å®¢æˆ¶è¨ªè«‡ã€‚' }, { name: 'M12', strategy: 'å¹´åº¦ç›®æ¨™é”æˆèˆ‡ç¸½çµ', actions: ['é€²è¡Œæœ€å¾Œåˆç´„ç°½è¨‚èˆ‡æ¬¾é …å‚¬æ”¶ã€‚', 'å¬é–‹å¹´åº¦æ¥­å‹™ç¸½çµæœƒè­°ï¼Œæª¢è¨OGSMé”æˆç‹€æ³ï¼Œè‰æ“¬ä¸‹å¹´åº¦è¨ˆç•«ã€‚'], kpi: 'å¹´åº¦ç¸½æ¥­ç¸¾é”æˆç‡100%ä»¥ä¸Šã€‚æå‡ºä¸‹å¹´åº¦æ¥­ç¸¾å¢é•·20%ç­–ç•¥è‰æ¡ˆã€‚' } ] }
            }
        };
        
        // --- DERIVED DATA OBJECTS ---
        let totals = {};
        let goalsData = {};
        let teamPerformanceData = {};

        // --- CHART INSTANCES ---
        let revenueChart, unitsChart, quarterlyPerformanceChart, monthlyPerformanceChart;

        // --- GLOBAL EDIT MODE ---
        const globalEditToggle = document.getElementById('global-edit-toggle');
        globalEditToggle.addEventListener('click', () => {
            const isEditMode = document.body.classList.toggle('edit-mode-active');
            globalEditToggle.textContent = isEditMode ? 'å®Œæˆç·¨è¼¯' : 'ç·¨è¼¯æ¨¡å¼';
            globalEditToggle.classList.toggle('bg-red-600', isEditMode);
            globalEditToggle.classList.toggle('hover:bg-red-700', isEditMode);
            globalEditToggle.classList.toggle('bg-blue-600', !isEditMode);
            globalEditToggle.classList.toggle('hover:bg-blue-700', !isEditMode);
            
            // Toggle contenteditable for all designated elements
            document.querySelectorAll('.editable').forEach(el => {
                el.contentEditable = isEditMode;
            });
            // Re-render the current quarter to apply editability to dynamic content
            const activeQuarterTab = document.querySelector('.quarter-tab.active');
            if (activeQuarterTab) {
                renderQuarterContent(activeQuarterTab.dataset.quarter);
            }
        });

        // --- DATA CALCULATION & UPDATE LOGIC ---
        function calculateAllData() {
            const sum = (arr) => arr.reduce((a, b) => a + b, 0);
            const { goals, revenueDistribution, unitsDistribution } = dataStore.appData;
            totals = {
                revenue: sum(goals.revenue),
                units: sum(goals.units),
                opportunities: sum(goals.opportunities),
                leads: sum(goals.leads),
                quarterly: {
                    revenue: [sum(goals.revenue.slice(0,3)), sum(goals.revenue.slice(3,6)), sum(goals.revenue.slice(6,9)), sum(goals.revenue.slice(9,12))],
                    units: [sum(goals.units.slice(0,3)), sum(goals.units.slice(3,6)), sum(goals.units.slice(6,9)), sum(goals.units.slice(9,12))]
                }
            };
            goalsData = {
                revenue: { labels: ['Essential', 'Standard', 'Enterprise', 'åŠ å€¼æœå‹™'], data: Object.values(revenueDistribution).map(ratio => totals.revenue * ratio), colors: ['#3b82f6', '#22c55e', '#f59e0b', '#a5b4fc'] },
                units: { labels: ['Essential', 'Standard', 'Enterprise'], data: Object.values(unitsDistribution).map(ratio => totals.units * ratio), colors: ['#8b5cf6', '#14b8a6', '#ec4899'] }
            };
            teamPerformanceData = {
                quarterlyRevenue: { target: totals.quarterly.revenue },
                quarterlyUnits: { target: totals.quarterly.units },
                monthlyRevenue: { target: goals.revenue },
                monthlyUnits: { target: goals.units }
            };
        }
        
        function updateAllVisuals() {
            calculateAllData();
            updateGoalsDOM();
            updateSpreadsheetCalculations();
            redrawAllCharts();
        }

        // --- DOM UPDATE & RENDERING FUNCTIONS ---
        function initializeTextContent() {
            document.querySelectorAll('[data-key-path]').forEach(el => {
                const keyPath = el.dataset.keyPath;
                const value = getObjectValueByPath(keyPath);
                if (value !== undefined) {
                    el.innerHTML = value;
                }
            });
        }

        function updateGoalsDOM() {
            document.getElementById('total-revenue').textContent = Math.round(totals.revenue).toLocaleString();
            document.getElementById('total-units').textContent = Math.round(totals.units).toLocaleString();
            document.getElementById('total-opportunities').textContent = Math.round(totals.opportunities).toLocaleString();
            document.getElementById('total-leads').textContent = Math.round(totals.leads).toLocaleString();
        }

        function renderSpreadsheet() {
            const table = document.getElementById('goal-spreadsheet');
            const metrics = { revenue: 'ç›®æ¨™æ¥­ç¸¾ (NT$)', units: 'ç›®æ¨™å¥—æ•¸', opportunities: 'ç›®æ¨™æœ‰æ•ˆå•†æ©Ÿ', leads: 'æ½›åœ¨å®¢æˆ¶' };
            let html = '<thead><tr><th>æŒ‡æ¨™</th>';
            for (let i = 1; i <= 12; i++) {
                html += `<th>M${i}</th>`;
                if (i % 3 === 0) html += `<th class="quarter-total">Q${i/3}</th>`;
            }
            html += '<th class="annual-total">å¹´åº¦ç¸½åˆ</th></tr></thead><tbody>';

            Object.entries(metrics).forEach(([key, name]) => {
                html += `<tr><td class="metric-header">${name}</td>`;
                for (let i = 0; i < 12; i++) {
                    html += `<td><div class="editable p-1 rounded" contenteditable="false" data-key-path="appData.goals.${key}.${i}">${dataStore.appData.goals[key][i].toLocaleString()}</div></td>`;
                    if ((i + 1) % 3 === 0) {
                        html += `<td class="quarter-total" data-q-total-metric="${key}" data-q-index="${Math.floor(i / 3)}"></td>`;
                    }
                }
                html += `<td class="annual-total" data-annual-total-metric="${key}"></td></tr>`;
            });
            html += '</tbody>';
            table.innerHTML = html;
            updateSpreadsheetCalculations();
        }
        
        function updateSpreadsheetCalculations() {
            const metrics = ['revenue', 'units', 'opportunities', 'leads'];
            metrics.forEach(key => {
                for (let i = 0; i < 4; i++) {
                    const qTotal = dataStore.appData.goals[key].slice(i * 3, i * 3 + 3).reduce((a,b) => a+b, 0);
                    const qCell = document.querySelector(`[data-q-total-metric="${key}"][data-q-index="${i}"]`);
                    if(qCell) qCell.textContent = qTotal.toLocaleString();
                }
                const annualTotal = dataStore.appData.goals[key].reduce((a,b) => a+b, 0);
                const annualCell = document.querySelector(`[data-annual-total-metric="${key}"]`);
                if(annualCell) annualCell.textContent = annualTotal.toLocaleString();
            });
        }

        function redrawAllCharts() {
            [revenueChart, unitsChart, quarterlyPerformanceChart, monthlyPerformanceChart].forEach(c => c?.destroy());
            const doughnutOptions = { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.dataset.label === 'NT$' ? 'NT$ ' : ''}${Math.round(c.raw).toLocaleString()}${c.dataset.label !== 'NT$' ? ' å¥—' : ''}` } } } };
            revenueChart = new Chart(document.getElementById('revenueChart'), { type: 'doughnut', data: { labels: goalsData.revenue.labels, datasets: [{ label: 'NT$', data: goalsData.revenue.data, backgroundColor: goalsData.revenue.colors }] }, options: doughnutOptions });
            unitsChart = new Chart(document.getElementById('unitsChart'), { type: 'doughnut', data: { labels: goalsData.units.labels, datasets: [{ label: 'å¥—', data: goalsData.units.data, backgroundColor: goalsData.units.colors }] }, options: doughnutOptions });
            
            const barChartOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { type: 'linear', display: true, position: 'left', beginAtZero: true, title: { display: true, text: 'æ¥­ç¸¾ (NT$)' }, ticks: { callback: value => Math.round(value / 10000) + 'è¬' } }, y1: { type: 'linear', display: true, position: 'right', beginAtZero: true, title: { display: true, text: 'å¥—æ•¸' }, grid: { drawOnChartArea: false }, ticks: { callback: value => Math.round(value) + 'å¥—' } } }, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.dataset.yAxisID === 'y1' ? Math.round(c.raw) + ' å¥—' : 'NT$ ' + Math.round(c.raw).toLocaleString()}` } } } };
            
            quarterlyPerformanceChart = new Chart(document.getElementById('quarterlyPerformanceChart'), { type: 'bar', data: { labels: ['Q1', 'Q2', 'Q3', 'Q4'], datasets: [{ label: 'ç›®æ¨™æ¥­ç¸¾', data: teamPerformanceData.quarterlyRevenue.target, backgroundColor: 'rgba(54, 162, 235, 0.5)', yAxisID: 'y' }, { label: 'ç›®æ¨™å¥—æ•¸', data: teamPerformanceData.quarterlyUnits.target, backgroundColor: 'rgba(255, 159, 64, 0.5)', yAxisID: 'y1' }] }, options: barChartOptions });
            monthlyPerformanceChart = new Chart(document.getElementById('monthlyPerformanceChart'), { type: 'bar', data: { labels: Array.from({length: 12}, (_, i) => `M${i+1}`), datasets: [{ label: 'ç›®æ¨™æ¥­ç¸¾', data: teamPerformanceData.monthlyRevenue.target, backgroundColor: 'rgba(75, 192, 192, 0.5)', yAxisID: 'y' }, { label: 'ç›®æ¨™å¥—æ•¸', data: teamPerformanceData.monthlyUnits.target, backgroundColor: 'rgba(255, 99, 132, 0.5)', yAxisID: 'y1' }] }, options: barChartOptions });
        }
        
        function renderQuarterContent(quarterKey) {
            const data = dataStore.measuresData[quarterKey];
            const quarterIndex = parseInt(quarterKey.replace('q', '')) - 1;
            const isEditMode = document.body.classList.contains('edit-mode-active');
            let contentHTML = `<div class="bg-blue-50 p-4 rounded-lg mb-6 text-center"><h3 class="font-bold text-blue-800">å­£åº¦é‡é»: <span class="editable p-1 rounded" contenteditable="${isEditMode}" data-key-path="measuresData.${quarterKey}.focus">${data.focus}</span></h3></div><div class="space-y-4">`;
            
            data.months.forEach((month, index) => {
                const monthIndex = quarterIndex * 3 + index;
                const actionsHTML = month.actions.map((action, actionIndex) => `<div class="flex items-start space-x-2 mb-2"><input type="checkbox" class="mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 flex-shrink-0"><p class="editable flex-grow p-1 rounded" contenteditable="${isEditMode}" data-key-path="measuresData.${quarterKey}.months.${index}.actions.${actionIndex}">${action}</p><button type="button" class="remove-action-btn items-center justify-center text-red-500 hover:text-red-700 font-bold text-xl flex-shrink-0 w-6 h-6" data-quarter="${quarterKey}" data-month-index="${index}" data-action-index="${actionIndex}">&times;</button></div>`).join('');
                
                contentHTML += `<div class="month-card border border-gray-200 rounded-lg"><div class="month-header flex items-center p-4 text-left"><div class="flex-grow font-bold flex items-center gap-2"><span>${month.name} -</span><span class="editable p-1 rounded" contenteditable="${isEditMode}" data-key-path="measuresData.${quarterKey}.months.${index}.strategy">${month.strategy}</span></div></div><div class="p-4 pt-2 grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-gray-50 p-3 rounded"><h4 class="font-semibold text-sm text-gray-500 mb-2">å…·é«”åŸ·è¡Œæ–¹æ¡ˆ</h4><div class="actions-list">${actionsHTML}</div><button type="button" class="add-action-btn mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold" data-quarter="${quarterKey}" data-month-index="${index}">+ æ–°å¢åŸ·è¡Œé …ç›®</button></div><div class="bg-gray-50 p-3 rounded flex flex-col"><h4 class="font-semibold text-sm text-gray-500 mb-2">æª¢æ ¸æŒ‡æ¨™</h4><textarea class="editable w-full p-2 rounded border-transparent text-sm flex-grow bg-transparent" ${isEditMode ? '' : 'readonly'} data-key-path="measuresData.${quarterKey}.months.${index}.kpi" style="resize: none;">${month.kpi}</textarea><div class="mt-3 pt-3 border-t border-gray-200 text-xs text-gray-600 space-y-1"><p><strong>ç•¶æœˆç›®æ¨™:</strong></p><p class="pl-2">æ¥­ç¸¾: <span class="font-semibold text-green-700">NT$ ${dataStore.appData.goals.revenue[monthIndex].toLocaleString()}</span></p><p class="pl-2">å¥—æ•¸: <span class="font-semibold text-blue-700">${dataStore.appData.goals.units[monthIndex].toLocaleString()} å¥—</span></p></div></div></div><div class="px-4 pb-4 flex items-center justify-end"><button class="ai-assistant-btn bg-blue-500 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-1" data-quarter="${quarterKey}" data-month-index="${index}">âœ¨ AI æ¥­å‹™åŠ©ç†</button></div></div>`;
            });
            contentHTML += `</div>`;
            document.getElementById('measures-content').innerHTML = contentHTML;
        }

        // --- EVENT LISTENERS & HANDLERS ---
        function attachUniversalListeners() {
            // Auto-save for all editable elements
            document.body.addEventListener('blur', (e) => {
                if (e.target.matches('.editable[contenteditable], .editable[readonly=""]')) {
                    const keyPath = e.target.dataset.keyPath;
                    if (!keyPath) return;
                    const value = e.target.matches('div, p, span, h1, h2, h3') ? e.target.innerHTML.trim() : e.target.value.trim();
                    setObjectValueByPath(keyPath, value);
                    if (keyPath.startsWith('appData.goals')) {
                        const numericValue = parseFloat(value.replace(/[^0-9.]/g, '') || 0);
                        e.target.textContent = numericValue.toLocaleString();
                        updateAllVisuals();
                    }
                }
            }, true);
            document.body.addEventListener('input', (e) => {
                 if (e.target.matches('textarea.editable')) {
                    const keyPath = e.target.dataset.keyPath;
                    if(keyPath) setObjectValueByPath(keyPath, e.target.value);
                }
            });
             document.body.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.matches('.editable[contenteditable="true"]')) {
                    e.preventDefault();
                    e.target.blur();
                }
            });

            // Navigation
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.content-section');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        navLinks.forEach(link => link.classList.toggle('active', link.getAttribute('href') === '#' + entry.target.id));
                    }
                });
            }, { rootMargin: '-40% 0px -60% 0px' });
            sections.forEach(section => observer.observe(section));
            navLinks.forEach(anchor => anchor.addEventListener('click', (e) => { e.preventDefault(); document.querySelector(anchor.getAttribute('href')).scrollIntoView({ behavior: 'smooth' }); }));

            // Measures Section Dynamic Listeners
            const measuresContainer = document.getElementById('measures-content');
            measuresContainer.addEventListener('click', (e) => {
                if (e.target.matches('.add-action-btn')) {
                    const { quarter, monthIndex } = e.target.dataset;
                    dataStore.measuresData[quarter].months[monthIndex].actions.push('æ–°çš„åŸ·è¡Œé …ç›®');
                    renderQuarterContent(quarter);
                }
                if (e.target.matches('.remove-action-btn')) {
                    const { quarter, monthIndex, actionIndex } = e.target.dataset;
                    dataStore.measuresData[quarter].months[monthIndex].actions.splice(actionIndex, 1);
                    renderQuarterContent(quarter);
                }
                const aiBtn = e.target.closest('.ai-assistant-btn');
                if (aiBtn) {
                    const { quarter, monthIndex } = aiBtn.dataset;
                    openAIAssistantModal(quarter, monthIndex);
                }
            });

            // Quarter Tabs
            document.getElementById('quarter-tabs-container').addEventListener('click', (e) => {
                if (e.target.matches('.quarter-tab')) {
                    document.querySelectorAll('.quarter-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    renderQuarterContent(e.target.dataset.quarter);
                }
            });
        }

        // --- DATA UTILITIES ---
        function getObjectValueByPath(path) {
            return path.split('.').reduce((acc, part) => acc && acc[part], dataStore);
        }

        function setObjectValueByPath(path, value) {
            const keys = path.split('.');
            let obj = dataStore;
            for (let i = 0; i < keys.length - 1; i++) {
                obj = obj[keys[i]];
                if (typeof obj === 'undefined') return;
            }
            const finalKey = keys[keys.length - 1];
            const oldValue = obj[finalKey];
            if (typeof oldValue === 'number') {
                obj[finalKey] = parseFloat(value.replace(/[^0-9.]/g, '') || 0);
            } else {
                obj[finalKey] = value;
            }
        }

        // --- Gemini API Integration ---
        const modal = document.getElementById('gemini-modal');
        const modalTitle = document.getElementById('gemini-modal-title');
        const modalContent = document.getElementById('gemini-modal-content');
        const modalLoader = document.getElementById('gemini-modal-loader');
        modal.addEventListener('click', (e) => { if (e.target.matches('#gemini-modal, #gemini-modal-close')) modal.classList.remove('show'); });

        async function callGemini(prompt) {
            modalContent.innerHTML = '';
            modalLoader.style.display = 'block';
            modal.classList.add('show');
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] }) });
                if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    modalContent.innerHTML = marked.parse(result.candidates[0].content.parts[0].text);
                } else {
                    modalContent.textContent = 'æŠ±æ­‰ï¼ŒAI ç„¡æ³•ç”Ÿæˆå›æ‡‰ã€‚';
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                modalContent.textContent = `ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`;
            } finally {
                modalLoader.style.display = 'none';
            }
        }

        function openAIAssistantModal(quarterKey, monthIndex) {
            const monthData = dataStore.measuresData[quarterKey].months[monthIndex];
            const monthGlobalIndex = (parseInt(quarterKey.replace('q', '')) - 1) * 3 + parseInt(monthIndex);
            const context = {
                ...monthData,
                monthRevenue: dataStore.appData.goals.revenue[monthGlobalIndex],
                monthUnits: dataStore.appData.goals.units[monthGlobalIndex]
            };
            modalTitle.textContent = `AI æ¥­å‹™åŠ©ç† (${context.name})`;
            const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ¥­å‹™ç­–ç•¥é¡§å•èˆ‡æ–‡æ¡ˆå¯«æ‰‹ã€‚è«‹æ ¹æ“šä»¥ä¸‹ ${context.name} çš„æ¥­å‹™è¨ˆç•«å…§å®¹ï¼Œæä¾›å…·é«”çš„å”åŠ©ã€‚\n\n### ${context.name} è¨ˆç•«æ‘˜è¦\n- **æ ¸å¿ƒç­–ç•¥:** ${context.strategy}\n- **ç•¶æœˆç›®æ¨™:** æ¥­ç¸¾ NT$ ${context.monthRevenue.toLocaleString()}, éŠ·å”® ${context.monthUnits} å¥—\n- **å…·é«”åŸ·è¡Œæ–¹æ¡ˆ:**\n  ${context.actions.map(a => `- ${a}`).join('\n')}\n- **æª¢æ ¸æŒ‡æ¨™ (KPI):** ${context.kpi}\n\n### ä½ çš„ä»»å‹™\nè«‹æ ¹æ“šä»¥ä¸Šè³‡è¨Šï¼Œæä¾› 2-3 å€‹å…·é«”çš„ã€å¯åŸ·è¡Œçš„å»ºè­°æˆ–æ–‡æ¡ˆè‰ç¨¿ï¼Œä»¥å”åŠ©æ¥­å‹™åœ˜éšŠé”æˆç›®æ¨™ã€‚æ€è€ƒæ–¹å‘å¯ä»¥åŒ…å«ï¼š\n1.  **è¡Œå‹•å»ºè­°:** é‡å°ã€ŒåŸ·è¡Œæ–¹æ¡ˆã€ï¼Œæå‡ºæ›´ç´°ç·»ã€æ›´æœ‰å‰µæ„çš„ä½œæ³•ã€‚\n2.  **æ–‡æ¡ˆè‰ç¨¿:** é‡å°éœ€è¦å°å¤–æºé€šçš„é …ç›®ï¼ˆå¦‚ç ”è¨æœƒã€å®¢æˆ¶Emailã€ç¤¾ç¾¤è²¼æ–‡ï¼‰ï¼Œæä¾›å¸å¼•äººçš„æ–‡æ¡ˆè‰ç¨¿ã€‚\n3.  **é¢¨éšªæç¤º:** é»å‡ºæ½›åœ¨çš„æŒ‘æˆ°ï¼Œä¸¦æå‡ºæ‡‰å°å»ºè­°ã€‚\n\nè«‹ä»¥å°ˆæ¥­ã€æ¢ç†åˆ†æ˜çš„æ ¼å¼å‘ˆç¾ä½ çš„å»ºè­°ã€‚`;
            callGemini(prompt);
        }

        document.getElementById('ai-analyst-btn').addEventListener('click', () => {
            modalTitle.textContent = `AI ç¸¾æ•ˆæ´å¯Ÿ (åœ˜éšŠç¸½è¦½)`;
            const prompt = `ä½ æ˜¯ä¸€ä½é ‚å°–çš„æ•¸æ“šåˆ†æå¸«èˆ‡æ¥­å‹™ç¸½ç›£ã€‚è«‹åˆ†æä»¥ä¸‹ã€Œåœ˜éšŠç¸½è¦½ã€çš„ 2025 å¹´åº¦æ¥­å‹™ç›®æ¨™æ•¸æ“šï¼Œä¸¦æä¾›ç²¾é—¢çš„æ´å¯Ÿèˆ‡ç­–ç•¥å»ºè­°ã€‚\n\n### å¹´åº¦ç¸½ç›®æ¨™\n- **ç¸½æ¥­ç¸¾:** NT$ ${Math.round(totals.revenue).toLocaleString()}\n- **ç¸½å¥—æ•¸:** ${Math.round(totals.units)} å¥—\n\n### åœ˜éšŠç›®æ¨™æ•¸æ“š\n- **æ¯æœˆæ¥­ç¸¾ç›®æ¨™ (NT$):** ${teamPerformanceData.monthlyRevenue.target.map(r => r.toLocaleString()).join(', ')}\n- **æ¯æœˆå¥—æ•¸ç›®æ¨™:** ${teamPerformanceData.monthlyUnits.target.map(u => Math.round(u)).join(', ')}\n\n### ä½ çš„ä»»å‹™\nè«‹æ ¹æ“šä»¥ä¸Šæ•¸æ“šï¼Œç”Ÿæˆä¸€ä»½ç°¡æ½”çš„åˆ†æå ±å‘Šï¼ŒåŒ…å«ä»¥ä¸‹å¹¾é»ï¼š\n1.  **è¶¨å‹¢ç¸½çµ:** æè¿°å…¨å¹´åº¦æ¥­ç¸¾èˆ‡å¥—æ•¸ç›®æ¨™çš„å¢é•·è¶¨å‹¢ã€‚æ˜¯å¦æœ‰æ˜é¡¯çš„é«˜å³°æˆ–ä½è°·æœŸï¼Ÿ\n2.  **é—œéµå­£åº¦åˆ†æ:** å“ªå€‹å­£åº¦æ˜¯é”æˆå¹´åº¦ç›®æ¨™çš„é—œéµï¼Ÿè©²å­£åº¦çš„æŒ‘æˆ°å¯èƒ½åœ¨å“ªè£¡ï¼Ÿ\n3.  **ç­–ç•¥å»ºè­°:** åŸºæ–¼æ•¸æ“šè¶¨å‹¢ï¼Œæå‡º 2-3 é»ç­–ç•¥å»ºè­°ã€‚\n4.  **æ½›åœ¨é¢¨éšª:** é»å‡ºæ½›åœ¨çš„é¢¨éšªï¼Œä¸¦å»ºè­°æ‡‰å°æªæ–½ã€‚\n\nè«‹ä»¥å°ˆæ¥­ã€æ•¸æ“šé©…å‹•çš„å£å»ï¼Œæä¾›æ¸…æ™°ã€å¯åŸ·è¡Œçš„æ´å¯Ÿã€‚`;
            callGemini(prompt);
        });

        // --- SAVE AS NEW VERSION ---
        document.getElementById('save-as-version-btn').addEventListener('click', () => {
            if (document.body.classList.contains('edit-mode-active')) {
                globalEditToggle.click(); // Exit edit mode to ensure UI is clean
            }
            const clonedDoc = document.documentElement.cloneNode(true);
            const scriptTag = clonedDoc.querySelector('script:not([src])');
            if (scriptTag) {
                // Replace the initial dataStore declaration with the current, modified state.
                let scriptContent = scriptTag.innerHTML;
                scriptContent = scriptContent.replace(
                    /let dataStore = \{[\s\S]*?};/, 
                    `let dataStore = ${JSON.stringify(dataStore, null, 4)};`
                );
                scriptTag.innerHTML = scriptContent;
            }
            const newTitle = (dataStore.textData.mainTitle.trim() || 'OGSMè¨ˆç•«') + " (äº’å‹•å¼å‰¯æœ¬).html";
            const htmlString = '<!DOCTYPE html>\n' + clonedDoc.outerHTML;
            const blob = new Blob([htmlString], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = newTitle;
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
        });
        
        // --- INITIALIZATION ---
        function initialize() {
            updateAllVisuals();
            initializeTextContent();
            renderSpreadsheet();
            attachUniversalListeners();
            document.querySelector('.quarter-tab[data-quarter="q1"]').click();
        }

        initialize();
    });
    </script>
</body>
</html>
